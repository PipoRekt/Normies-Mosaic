<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Normies — 10K Mosaic</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #111; color: #eee;
      font-family: system-ui, -apple-system, sans-serif;
      overflow: hidden; height: 100vh; width: 100vw;
    }
    #topbar {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      background: rgba(10,10,10,0.92); backdrop-filter: blur(8px);
      display: flex; align-items: center; gap: 16px;
      padding: 10px 16px; border-bottom: 1px solid #333;
      flex-wrap: wrap;
    }
    #topbar h1 {
      font-family: "Courier New", monospace;
      font-size: 16px; font-weight: 400;
      letter-spacing: 0.2em; color: #fff;
    }
    #progress-wrap { flex: 1; display: flex; align-items: center; gap: 10px; min-width: 200px; }
    #progress-bar-bg { flex: 1; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
    #progress-bar { height: 100%; background: #fff; width: 0%; transition: width 0.3s; }
    #progress-label { font-size: 12px; color: #aaa; white-space: nowrap; }
    #hint-label { font-size: 11px; color: #555; white-space: nowrap; }
    #download-btn, #download-jpg-btn {
      padding: 6px 12px; border-radius: 4px; border: 1px solid #444;
      background: #1a6e2e; color: #fff; font-size: 12px;
      cursor: pointer; white-space: nowrap; flex-shrink: 0;
    }
    #download-btn:hover, #download-jpg-btn:hover { background: #155924; }
    #download-btn:disabled, #download-jpg-btn:disabled { background: #333; color: #666; border-color: #333; cursor: not-allowed; }

    #canvas-wrap {
      position: fixed; top: 48px; left: 0; right: 0; bottom: 0;
      overflow: hidden; cursor: grab; background: #111;
    }
    #canvas-wrap.grabbing { cursor: grabbing; }
    #mosaic-canvas { position: absolute; top: 0; left: 0; image-rendering: pixelated; }

    #info-panel {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(10,10,10,0.96); border: 1px solid #444;
      border-radius: 8px; padding: 12px 16px;
      display: none; align-items: center; gap: 12px;
      z-index: 200; min-width: 240px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    #info-panel.visible { display: flex; }
    #info-thumb {
      width: 56px; height: 56px; image-rendering: pixelated;
      border-radius: 4px; background: #222; flex-shrink: 0;
      border: 1px solid #333;
    }
    #info-name  { font-weight: 600; font-size: 14px; }
    #info-sub   { font-family: "Courier New", monospace; font-size: 11px; color: #888; margin-top: 3px; }
    #info-close { margin-left: auto; background: none; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 0 4px; line-height: 1; }
    #info-close:hover { color: #fff; }

    #zoom-controls {
      position: fixed; right: 16px; bottom: 20px; z-index: 100;
      display: flex; flex-direction: column; gap: 4px;
    }
    .zoom-btn {
      width: 32px; height: 32px;
      background: rgba(20,20,20,0.9); border: 1px solid #444;
      border-radius: 4px; color: #eee; font-size: 16px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .zoom-btn:hover { background: #2a2a2a; border-color: #666; }

    #loading-overlay {
      position: fixed; inset: 0; background: #111;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 300; gap: 16px;
    }
    #loading-overlay h2 { font-family: "Courier New", monospace; font-weight: 400; letter-spacing: 0.2em; }
    #loading-overlay p  { color: #666; font-size: 13px; }
    #loading-overlay.hidden { display: none; }
  </style>
</head>
<body>

<div id="loading-overlay">
  <h2>nørmies mosaic</h2>
  <p>Preparing 10 000 Normies…</p>
</div>

<div id="topbar">
  <h1>nørmies mosaic</h1>
  <div id="progress-wrap">
    <div id="progress-bar-bg"><div id="progress-bar"></div></div>
    <span id="progress-label">0 / 10 000</span>
  </div>
  <span id="hint-label">Scroll to zoom · Drag to pan · Click a Normie</span>
  <button id="download-btn" disabled>⬇ PNG</button>
  <button id="download-jpg-btn" disabled>⬇ JPG</button>
</div>

<div id="canvas-wrap">
  <canvas id="mosaic-canvas"></canvas>
</div>

<div id="info-panel">
  <img id="info-thumb" src="" alt="" />
  <div>
    <div id="info-name">—</div>
    <div id="info-sub">—</div>
  </div>
  <button id="info-close">×</button>
</div>

<div id="zoom-controls">
  <button class="zoom-btn" id="zoom-in">+</button>
  <button class="zoom-btn" id="zoom-out">−</button>
  <button class="zoom-btn" id="zoom-fit" style="font-size:10px;letter-spacing:-0.5px">fit</button>
</div>

<script>
  const COLS      = 100;
  const ROWS      = 100;
  const TOTAL     = 10000;
  const CELL      = 40;
  const W         = COLS * CELL;  // 4000px
  const H         = ROWS * CELL;  // 4000px
  const CONCURRENT = 30;
  const CONTRACT  = '0x9eb6e2025b64f340691e424b7fe7022ffde12438';

  // ── Shuffle ────────────────────────────────────────────
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  const ORDER = shuffle([...Array(TOTAL).keys()]);  // ORDER[gridIndex] = tokenId

  // ── Canvas ─────────────────────────────────────────────
  const wrap   = document.getElementById('canvas-wrap');
  const canvas = document.getElementById('mosaic-canvas');
  const ctx    = canvas.getContext('2d');
  canvas.width  = W;
  canvas.height = H;

  // Checkerboard background
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      ctx.fillStyle = (c + r) % 2 === 0 ? '#1a1a1a' : '#1f1f1f';
      ctx.fillRect(c * CELL, r * CELL, CELL, CELL);
    }
  }

  // ── Viewport ───────────────────────────────────────────
  let scale = Math.min(wrap.clientWidth / W, wrap.clientHeight / H) * 0.9;
  let panX  = (wrap.clientWidth  - W * scale) / 2;
  let panY  = (wrap.clientHeight - H * scale) / 2;

  function applyTransform() {
    canvas.style.transform      = `translate(${panX}px,${panY}px) scale(${scale})`;
    canvas.style.transformOrigin = '0 0';
  }
  applyTransform();

  wrap.addEventListener('wheel', e => {
    e.preventDefault();
    const f  = e.deltaY < 0 ? 1.12 : 0.88;
    const mx = e.clientX - wrap.getBoundingClientRect().left;
    const my = e.clientY - wrap.getBoundingClientRect().top;
    panX     = mx - (mx - panX) * f;
    panY     = my - (my - panY) * f;
    scale    = Math.max(0.04, Math.min(25, scale * f));
    applyTransform();
  }, { passive: false });

  let drag = false, sx, sy, spx, spy, moved = false;
  wrap.addEventListener('mousedown', e => {
    drag = true; moved = false;
    sx = e.clientX; sy = e.clientY; spx = panX; spy = panY;
    wrap.classList.add('grabbing');
  });
  window.addEventListener('mousemove', e => {
    if (!drag) return;
    const dx = e.clientX - sx, dy = e.clientY - sy;
    if (Math.abs(dx) + Math.abs(dy) > 4) moved = true;
    panX = spx + dx; panY = spy + dy;
    applyTransform();
  });
  window.addEventListener('mouseup', e => {
    if (drag && !moved) handleClick(e);
    drag = false;
    wrap.classList.remove('grabbing');
  });

  document.getElementById('zoom-in').onclick  = () => zoom(1.3);
  document.getElementById('zoom-out').onclick = () => zoom(1/1.3);
  document.getElementById('zoom-fit').onclick = fitToScreen;

  function zoom(f) {
    const cx = wrap.clientWidth / 2, cy = wrap.clientHeight / 2;
    panX  = cx - (cx - panX) * f;
    panY  = cy - (cy - panY) * f;
    scale = Math.max(0.04, Math.min(25, scale * f));
    applyTransform();
  }
  function fitToScreen() {
    scale = Math.min(wrap.clientWidth / W, wrap.clientHeight / H) * 0.9;
    panX  = (wrap.clientWidth  - W * scale) / 2;
    panY  = (wrap.clientHeight - H * scale) / 2;
    applyTransform();
  }

  // ── Click → info panel ─────────────────────────────────
  const infoPanel = document.getElementById('info-panel');
  const infoThumb = document.getElementById('info-thumb');
  const infoName  = document.getElementById('info-name');
  const infoSub   = document.getElementById('info-sub');
  const imgCache  = {};

  function handleClick(e) {
    const rect = wrap.getBoundingClientRect();
    const cx   = (e.clientX - rect.left - panX) / scale;
    const cy   = (e.clientY - rect.top  - panY) / scale;
    const col  = Math.floor(cx / CELL);
    const row  = Math.floor(cy / CELL);
    if (col < 0 || row < 0 || col >= COLS || row >= ROWS) return;
    const idx     = row * COLS + col;
    const tokenId = ORDER[idx];
    infoThumb.src        = imgCache[tokenId] || '';
    infoName.textContent = `Normie #${tokenId}`;
    infoSub.textContent  = `Position (${col + 1}, ${row + 1}) — Token ID ${tokenId}`;
    infoPanel.classList.add('visible');
  }
  document.getElementById('info-close').onclick = () => infoPanel.classList.remove('visible');

  // ── Load images via /api/normie ────────────────────────
  const progressBar   = document.getElementById('progress-bar');
  const progressLabel = document.getElementById('progress-label');
  const overlay       = document.getElementById('loading-overlay');
  let loaded = 0;

  function updateProgress() {
    loaded++;
    const pct = loaded / TOTAL * 100;
    progressBar.style.width  = pct + '%';
    progressLabel.textContent = loaded === TOTAL
      ? '✓ All 10 000 Normies loaded!'
      : `${loaded.toLocaleString()} / 10 000`;
    if (loaded === TOTAL) { progressBar.style.background = '#4caf50'; checkAllLoaded(); }
  }

  function drawToken(tokenId, idx, imgSrc) {
    const col = idx % COLS;
    const row = Math.floor(idx / COLS);
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => ctx.drawImage(img, col * CELL, row * CELL, CELL, CELL);
    img.src    = imgSrc;
    imgCache[tokenId] = imgSrc;
  }

  function drawError(idx) {
    const col = idx % COLS;
    const row = Math.floor(idx / COLS);
    ctx.fillStyle = '#252525';
    ctx.fillRect(col * CELL, row * CELL, CELL, CELL);
    ctx.fillStyle = '#3a3a3a';
    ctx.font = `${CELL * 0.35}px monospace`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('✕', col * CELL + CELL / 2, row * CELL + CELL / 2);
  }

  async function loadToken(idx) {
    const tokenId = ORDER[idx];
    try {
      const res  = await fetch(`/api/normie?id=${tokenId}`);
      if (!res.ok) throw new Error();
      const data = await res.json();
      if (data.imageUrl) drawToken(tokenId, idx, data.imageUrl);
      else drawError(idx);
    } catch {
      drawError(idx);
    }
    updateProgress();
  }

  async function loadAll() {
    // Remove overlay once first batch starts rendering
    overlay.classList.add('hidden');

    let cursor = 0;
    while (cursor < TOTAL) {
      const batch = [];
      for (let i = 0; i < CONCURRENT && cursor < TOTAL; i++, cursor++) {
        batch.push(loadToken(cursor));
      }
      await Promise.all(batch);
    }
  }

  // ── Download ───────────────────────────────────────────
  function downloadMosaic(format) {
    const btnId = format === 'jpg' ? 'download-jpg-btn' : 'download-btn';
    const btn   = document.getElementById(btnId);
    btn.disabled = true;
    btn.textContent = 'Preparing…';
    setTimeout(() => {
      const mime    = format === 'jpg' ? 'image/jpeg' : 'image/png';
      const link    = document.createElement('a');
      link.download = `normies-mosaic-10k.${format}`;
      link.href     = canvas.toDataURL(mime, 1.0);
      link.click();
      btn.disabled = false;
      btn.textContent = format === 'jpg' ? '⬇ JPG' : '⬇ PNG';
    }, 50);
  }

  document.getElementById('download-btn').addEventListener('click',     () => downloadMosaic('png'));
  document.getElementById('download-jpg-btn').addEventListener('click', () => downloadMosaic('jpg'));

  // Enable download button when all loaded
  function checkAllLoaded() {
    if (loaded >= TOTAL) {
      document.getElementById('download-btn').disabled     = false;
      document.getElementById('download-jpg-btn').disabled = false;
    }
  }

  // Small delay to let the canvas render first
  setTimeout(loadAll, 100);
</script>
</body>
</html>
